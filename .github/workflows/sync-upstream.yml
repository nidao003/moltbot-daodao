name: 'Sync with MoltBot Upstream'

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæ¯å¤©UTCæ—¶é—´2:00ï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰è¿è¡Œ
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼šåœ¨GitHubé¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # å¯é€‰ï¼šå½“åŸå§‹ä»“åº“æœ‰æ¨é€æ—¶è§¦å‘ï¼ˆéœ€è¦è®¾ç½®webhookï¼Œæ›´é«˜çº§ï¼‰
  # repository_dispatch:
  #   types: [upstream_updated]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æ¨é€æ›´æ”¹
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # æ­¥éª¤2ï¼šé…ç½®Git
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global pull.rebase false
          
      # æ­¥éª¤3ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶åŒæ­¥
      - name: Sync from MoltBot upstream
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/moltbot/moltbot.git
          
          # è·å–ä¸Šæ¸¸æ›´æ–°
          echo "æ­£åœ¨è·å–ä¸Šæ¸¸ä»“åº“æ›´æ–°..."
          git fetch upstream main
          
          # åˆå¹¶æ›´æ–°ï¼ˆä½¿ç”¨--no-ffä¿ç•™åˆå¹¶è®°å½•ï¼‰
          echo "æ­£åœ¨åˆå¹¶åˆ°æœ¬åœ°åˆ†æ”¯..."
          git checkout main
          
          # å°è¯•åˆå¹¶ï¼Œå¦‚æœå†²çªåˆ™ä¼˜é›…å¤±è´¥
          if git merge upstream/main --no-edit --no-ff; then
            echo "âœ… åˆå¹¶æˆåŠŸï¼Œæ¨é€æ›´æ–°..."
            
            # æ¨é€æ›´æ–°åˆ°ä½ çš„fork
            if git push origin main; then
              echo "ğŸ‰ åŒæ­¥å®Œæˆï¼Forkå·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
              
              # å¯é€‰ï¼šåˆ›å»ºåŒæ­¥å®Œæˆçš„æ ‡è®°
              echo "SYNC_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™"
              exit 1
            fi
          else
            echo "âš ï¸ åˆå¹¶å‘ç”Ÿå†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
            echo "å†²çªæ–‡ä»¶ï¼š"
            git status --porcelain | grep -E '^(AA|UU|DU|UD)'
            
            # æ’¤é”€åˆå¹¶
            git merge --abort
            
            # ç§»é™¤ä¸Šæ¸¸remoteä¿æŒå¹²å‡€
            git remote remove upstream
            
            echo "::warning::æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³"
            exit 1
          fi
          
      # æ­¥éª¤4ï¼šå¯é€‰-å‘é€é€šçŸ¥ï¼ˆéœ€è¦è®¾ç½®secretsï¼‰
      - name: Notify on success
        if: success() && env.SYNC_SUCCESS == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… å·²è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“ [moltbot/moltbot](https://github.com/moltbot/moltbot) çš„æœ€æ–°æ›´æ”¹åˆ°æœ¬ä»“åº“ã€‚'
            })
